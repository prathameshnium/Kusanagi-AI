<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orochimaru - Secure Local RAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js for local parsing (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Marked for Markdown (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for XSS Protection (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    


    <link rel="stylesheet" href="../static/style.css">
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body class="h-full bg-primary text-fg-primary font-sans antialiased overflow-hidden">
    <a href="https://prathameshnium.github.io/Kusanagi-AI" class="home-button">Home</a>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden absolute inset-0 bg-black/90 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-secondary p-6 rounded-lg shadow-2xl max-w-md w-full border border-tertiary relative">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold text-accent">Secure Configuration</h2>
                <button onclick="toggleSettings()" class="text-fg-secondary hover:text-fg-primary">‚úï</button>
            </div>

            <div class="bg-green-900/20 border border-green-900 p-3 rounded mb-6 text-xs text-green-200">
                <strong>üõ°Ô∏è Architecture Audit:</strong> 
                <ul class="list-disc ml-4 mt-2 space-y-1">
                    <li><strong>PDF Processing:</strong> 100% Client-Side (RAM). No server uploads.</li>
                    <li><strong>Data Persistence:</strong> Volatile. Wiped on page refresh.</li>
                    <li><strong>Network:</strong> Direct connection to AI API only. No proxies.</li>
                </ul>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm text-fg-secondary mb-2">AI Provider</label>
                <select id="provider-select" class="w-full bg-tertiary text-fg-primary p-2 rounded border border-tertiary focus:border-accent outline-none" onchange="updateKeyInput()">
                    <option value="gemini">Google Gemini (Recommended)</option>
                    <option value="groq">Groq (Fastest)</option>
                    <option value="hf">Hugging Face</option>
                    <option value="ollama">Local Ollama (localhost:11434)</option>
                </select>
            </div>

            <div class="mb-6" id="api-key-container">
                <label class="block text-sm text-fg-secondary mb-2">API Key / Endpoint</label>
                <!-- autocomplete="off" prevents browser saving keys -->
                <input type="password" id="api-key-input" autocomplete="off" class="w-full bg-tertiary text-fg-primary p-2 rounded border border-tertiary focus:border-accent outline-none" placeholder="Enter key...">
                <p id="ollama-hint" class="hidden text-[10px] text-fg-secondary mt-1">Default: http://localhost:11434 (Leave empty for default)</p>
            </div>

            <div class="flex justify-between items-center pt-4 border-t border-tertiary">
                <button onclick="purgeData()" class="text-danger text-xs hover:text-red-200 underline decoration-dotted" title="Wipe local storage and reload">üî• Secure Wipe</button>
                <div class="flex gap-2">
                    <button onclick="toggleSettings()" class="px-4 py-2 text-fg-secondary hover:text-fg-primary">Cancel</button>
                    <button onclick="saveSettings()" class="px-4 py-2 bg-accent text-accent-fg rounded font-bold hover:bg-yellow-500">Save Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex h-full max-h-screen">
        
        <!-- === Sidebar === -->
        <aside class="w-72 flex-shrink-0 bg-secondary flex flex-col p-4 border-r border-tertiary overflow-y-auto custom-scrollbar">
            <!-- Header -->
            <div class="px-1 mb-6">
                <h1 class="text-2xl font-bold text-accent flex items-center gap-2">
                    Orochimaru
                    <span class="text-[10px] bg-tertiary text-fg-secondary px-2 py-0.5 rounded border border-tertiary">Local</span>
                </h1>
                <p class="text-xs text-fg-secondary mt-1">Secure RAG Environment</p>
            </div>

            <!-- File Upload -->
            <div class="mb-6">
                <input type="file" id="pdf-upload" accept=".pdf" class="hidden" onchange="handleFileUpload(this)">
                <button onclick="document.getElementById('pdf-upload').click()" class="w-full bg-accent text-accent-fg font-bold py-3 px-4 rounded-md hover:bg-yellow-600 transition duration-200 flex items-center justify-center gap-2 shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Load Document (RAM)
                </button>
                <p class="text-[10px] text-center text-fg-secondary mt-2 opacity-70">Files never leave this device.</p>
            </div>

            <!-- AI Settings Panel -->
            <div class="bg-tertiary/30 rounded-lg p-3 mb-4 border border-tertiary">
                <h3 class="text-xs font-bold text-fg-secondary uppercase mb-3">AI Settings</h3>
                
                <!-- Model Selector -->
                <div class="mb-3">
                    <label class="block text-[10px] text-fg-secondary mb-1">Model</label>
                    <select id="model-select" class="w-full bg-primary text-xs text-fg-primary p-1.5 rounded border border-tertiary focus:border-accent outline-none">
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <!-- Temperature Slider -->
                <div>
                    <div class="flex justify-between text-[10px] text-fg-secondary mb-1">
                        <label>Temperature</label>
                        <span id="temp-val" class="text-accent font-mono">0.3</span>
                    </div>
                    <input type="range" id="temp-slider" min="0" max="1" step="0.1" value="0.3" class="w-full h-1 bg-primary rounded-lg appearance-none cursor-pointer">
                </div>
            </div>

            <!-- Status Panel -->
            <div class="bg-tertiary/30 rounded-lg p-3 mb-4 border border-tertiary">
                <h3 class="text-xs font-bold text-fg-secondary uppercase mb-2 flex justify-between">
                    System Status
                    <div class="w-2 h-2 bg-danger rounded-full" id="status-dot"></div>
                </h3>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between">
                        <span>AI Link:</span>
                        <span id="status-ai" class="text-fg-secondary">Disconnected</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Document:</span>
                        <span id="status-doc" class="text-fg-secondary truncate max-w-[100px]">None</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Chunks:</span>
                        <span id="status-chunks" class="text-fg-primary">0</span>
                    </div>
                </div>
            </div>

            <!-- Document List -->
            <div class="mb-4 flex-grow flex flex-col min-h-[150px]">
                <h3 class="text-xs font-bold text-fg-secondary uppercase mb-2 flex justify-between items-center">
                    Loaded Documents <span id="doc-count" class="text-accent bg-tertiary px-1.5 rounded">0</span>
                </h3>
                <div id="doc-list" class="space-y-1 overflow-y-auto custom-scrollbar pr-1 flex-grow">
                    <!-- Empty State -->
                    <div id="empty-docs" class="text-[10px] text-fg-secondary italic p-4 text-center border border-dashed border-tertiary rounded">
                        No documents in RAM.<br>Load a PDF to begin.
                    </div>
                    <!-- Dynamic Items will go here -->
                </div>
            </div>

            <!-- Quick Actions -->
            <div id="quick-actions" class="space-y-2 opacity-50 pointer-events-none transition-opacity">
                <button onclick="runQuickAction('summarize')" class="w-full text-left px-3 py-2 rounded hover:bg-tertiary text-sm text-fg-primary border border-transparent hover:border-accent transition flex items-center gap-2">
                    üìù Summarize All
                </button>
                
                <!-- Review Dropdown Trigger -->
                <div class="relative">
                    <button onclick="toggleReviewMenu()" class="w-full text-left px-3 py-2 rounded hover:bg-tertiary text-sm text-fg-primary border border-transparent hover:border-accent transition flex items-center gap-2 justify-between">
                        <span>üßê Expert Review</span>
                        <span class="text-[10px]">‚ñº</span>
                    </button>
                    
                    <!-- Review Personas (Hidden by default) -->
                    <div id="review-menu" class="hidden ml-4 mt-1 border-l-2 border-tertiary pl-2 space-y-1 bg-secondary">
                        <button onclick="runReview('Physicist')" class="w-full text-left px-2 py-1.5 text-xs text-fg-secondary hover:text-accent transition">üî¨ Physicist</button>
                        <button onclick="runReview('Chemist')" class="w-full text-left px-2 py-1.5 text-xs text-fg-secondary hover:text-accent transition">üß™ Chemist</button>
                        <button onclick="runReview('Editor')" class="w-full text-left px-2 py-1.5 text-xs text-fg-secondary hover:text-accent transition">‚úçÔ∏è Editor</button>
                    </div>
                </div>
            </div>

            <div class="mt-auto pt-4 border-t border-tertiary">
                 <button onclick="toggleSettings()" class="flex items-center gap-2 text-sm text-fg-secondary hover:text-accent transition w-full">
                    <span>‚öôÔ∏è</span> Configure API
                 </button>
            </div>
        </aside>

        <!-- === Main Area === -->
        <main class="flex-1 flex flex-col max-h-screen relative bg-primary">
            <!-- Top Bar -->
            <header class="flex-shrink-0 h-14 border-b border-tertiary flex items-center justify-between px-4 bg-secondary/50">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-success rounded-full secure-indicator" title="Encrypted RAM Session"></div>
                        <span class="text-lg font-bold text-fg-primary" id="chat-header">Secure Workspace</span>
                    </div>
                    
                    <!-- Performance Monitor -->
                    <div class="hidden md:flex items-center gap-3 text-[10px] font-mono text-fg-secondary bg-secondary/80 px-3 py-1 rounded border border-tertiary">
                         <div title="Browser Memory Usage (Approx)">
                            <span class="text-accent">RAM:</span> <span id="perf-ram" class="text-fg-primary">--</span>
                        </div>
                        <div class="w-[1px] h-3 bg-tertiary"></div>
                        <div title="Total Tokens Used">
                            <span class="text-accent">Tokens:</span> <span id="perf-tokens" class="text-fg-primary">0</span>
                        </div>
                        <div class="w-[1px] h-3 bg-tertiary"></div>
                        <div title="Tokens Per Second">
                            <span class="text-accent">Speed:</span> <span id="perf-speed" class="text-fg-primary">--</span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <!-- TTS Button with ID for logic -->
                    <button id="tts-btn" onclick="toggleTTS()" class="text-fg-secondary hover:text-accent text-lg" title="Read Aloud">üîä</button>
                    
                    <div class="h-4 w-[1px] bg-tertiary"></div>
                    <button onclick="clearChat()" class="text-fg-secondary hover:text-danger text-sm" title="Clear Chat History">üóëÔ∏è Clear</button>
                </div>
            </header>

            <!-- Chat Container -->
            <div id="chat-history" class="flex-grow overflow-y-auto p-4 space-y-6 custom-scrollbar">
                <!-- Welcome Message -->
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-tertiary rounded-full flex items-center justify-center font-bold text-accent border border-accent">O</div>
                    <div class="bg-tertiary p-4 rounded-lg max-w-3xl shadow-md">
                        <p class="font-bold text-accent mb-1">Orochimaru (Secure Mode)</p>
                        <p>System is strictly local. Documents loaded here are processed in-memory and vanish upon reload.</p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="flex-shrink-0 p-4 bg-primary border-t border-tertiary">
                <div class="max-w-4xl mx-auto relative">
                    <div class="flex bg-tertiary rounded-lg border border-tertiary focus-within:border-accent shadow-lg transition-colors">
                        <input id="chat-input" type="text" placeholder="Query your private documents..." class="w-full bg-transparent p-3 text-fg-primary placeholder-fg-secondary focus:outline-none" onkeydown="if(event.key === 'Enter') handleSend()" autocomplete="off">
                        <button onclick="handleSend()" id="send-btn" class="px-4 text-accent hover:text-white transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </div>
                    <div class="text-center mt-2">
                         <span id="context-indicator" class="text-[10px] text-fg-secondary opacity-0 transition-opacity flex items-center justify-center gap-1">
                            <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            Searching local chunks...
                        </span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let config = {
            provider: localStorage.getItem('orc_provider') || 'gemini',
            apiKey: localStorage.getItem('orc_key') || ''
        };
        
        // MEMORY-ONLY STORAGE
        let loadedDocuments = {};
        let lastAIResponse = ""; 
        let sessionTotalTokens = 0;
        let isSpeaking = false; // Track TTS state

        const MODELS = {
            gemini: [
                {id: "gemini-2.5-flash", name: "Gemini 2.5 Flash"},
                {id: "gemini-2.0-flash", name: "Gemini 2.0 Flash"},
                {id: "gemini-1.5-flash", name: "Gemini 1.5 Flash"},
                {id: "gemini-1.5-pro", name: "Gemini 1.5 Pro"}
            ],
            groq: [
                {id: "llama3-8b-8192", name: "Llama 3 8B"},
                {id: "mixtral-8x7b-32768", name: "Mixtral 8x7B"},
                {id: "gemma-7b-it", name: "Gemma 7B"}
            ],
            hf: [
                {id: "mistralai/Mistral-7B-Instruct-v0.3", name: "Mistral 7B"},
                {id: "microsoft/Phi-3-mini-4k-instruct", name: "Phi-3 Mini"}
            ],
            ollama: [
                {id: "qwen2:1.5b", name: "Qwen 1.5B"},
                {id: "llama3", name: "Llama 3 (Local)"}
            ]
        };

        const REVIEW_PERSONAS = {
            "Physicist": "You are a reviewer with expertise in Physics. Focus on the underlying physical principles and models.",
            "Chemist": "You are a reviewer with expertise in Chemistry. Focus on chemical compositions and reactions.",
            "Editor": "You are an editor. Review the paper for clarity, grammar, style, and overall structure."
        };
        
        // Warn user on reload/close
        window.onbeforeunload = function() {
            if (Object.keys(loadedDocuments).length > 0) {
                return "All loaded documents will be lost. They are not saved.";
            }
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            document.getElementById('provider-select').value = config.provider;
            document.getElementById('api-key-input').value = config.apiKey;
            updateKeyInput();
            populateModelSelect(config.provider); // Init model list

            // Slider Listener
            const slider = document.getElementById('temp-slider');
            const valDisplay = document.getElementById('temp-val');
            slider.addEventListener('input', (e) => valDisplay.textContent = e.target.value);
            
            // Start Memory Monitor
            setInterval(updatePerfStats, 2000);
        });

        // --- PERFORMANCE MONITOR ---
        function updatePerfStats(tokensUsed = 0, speed = 0) {
            // Update Tokens
            if (tokensUsed > 0) {
                sessionTotalTokens += tokensUsed;
                document.getElementById('perf-tokens').textContent = sessionTotalTokens.toLocaleString();
            }
            
            // Update Speed if provided
            if (speed > 0) {
                document.getElementById('perf-speed').textContent = speed.toFixed(1) + " t/s";
            }

            // Update RAM (Best Effort)
            const ramEl = document.getElementById('perf-ram');
            if (performance.memory) {
                // Chrome/Edge only
                const usedMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                ramEl.textContent = `${usedMB} MB`;
            } else {
                // Fallback: Estimate based on loaded text length
                let charCount = 0;
                Object.values(loadedDocuments).forEach(chunks => {
                    chunks.forEach(c => charCount += c.length);
                });
                // Rough estimate: chars * 2 bytes + overhead
                const estMB = Math.round((charCount * 2) / 1024 / 1024) + 20; // Base overhead
                ramEl.textContent = `~${estMB} MB`;
            }
        }

        // --- SETTINGS & CONFIG ---
        function toggleSettings() {
            document.getElementById('settings-modal').classList.toggle('hidden');
        }

        function updateKeyInput() {
            const provider = document.getElementById('provider-select').value;
            const hint = document.getElementById('ollama-hint');
            const input = document.getElementById('api-key-input');
            
            populateModelSelect(provider); // Update sidebar models when provider changes

            if (provider === 'ollama') {
                input.placeholder = "http://localhost:11434";
                hint.classList.remove('hidden');
            } else {
                input.placeholder = "Enter API Key...";
                hint.classList.add('hidden');
            }
        }

        function populateModelSelect(provider) {
            const select = document.getElementById('model-select');
            select.innerHTML = "";
            const options = MODELS[provider] || [];
            options.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.name;
                select.appendChild(opt);
            });
        }

        function saveSettings() {
            const provider = document.getElementById('provider-select').value;
            let key = document.getElementById('api-key-input').value.trim();
            
            if (provider === 'ollama' && !key) key = "http://localhost:11434";
            
            if(key) {
                config.provider = provider;
                config.apiKey = key;
                localStorage.setItem('orc_provider', provider);
                localStorage.setItem('orc_key', key);
                checkStatus();
                toggleSettings();
            } else {
                alert("API Key cannot be empty");
            }
        }

        function purgeData() {
            if(confirm("CRITICAL: Wipe all local storage keys and reload? Documents in RAM will be lost.")) {
                localStorage.removeItem('orc_provider');
                localStorage.removeItem('orc_key');
                location.reload();
            }
        }

        function checkStatus() {
            const statusEl = document.getElementById('status-ai');
            const dot = document.getElementById('status-dot');
            
            if(config.apiKey) {
                statusEl.textContent = config.provider === 'ollama' ? "Local (Ollama)" : "Secure Cloud";
                statusEl.className = "text-success font-bold";
                dot.classList.remove('bg-danger');
                dot.classList.add('bg-success');
            } else {
                statusEl.textContent = "Keys Missing";
                statusEl.className = "text-danger";
                dot.classList.remove('bg-success');
                dot.classList.add('bg-danger');
            }
        }

        // --- DOCUMENT MANAGEMENT ---
        function updateDocListUI() {
            const listContainer = document.getElementById('doc-list');
            const emptyMsg = document.getElementById('empty-docs');
            const docCount = document.getElementById('doc-count');
            const quickActions = document.getElementById('quick-actions');
            const totalChunksEl = document.getElementById('status-chunks');

            const filenames = Object.keys(loadedDocuments);
            docCount.textContent = filenames.length;

            if (filenames.length === 0) {
                emptyMsg.classList.remove('hidden');
                quickActions.classList.add('opacity-50', 'pointer-events-none');
                listContainer.querySelectorAll('.doc-item').forEach(e => e.remove());
                totalChunksEl.textContent = "0";
                return;
            }

            emptyMsg.classList.add('hidden');
            quickActions.classList.remove('opacity-50', 'pointer-events-none');

            // Re-render list
            listContainer.querySelectorAll('.doc-item').forEach(e => e.remove());
            
            let totalChunks = 0;
            filenames.forEach(name => {
                totalChunks += loadedDocuments[name].length;
                
                const div = document.createElement('div');
                div.className = "doc-item bg-tertiary rounded p-2 flex justify-between items-center group mb-1";
                div.innerHTML = `
                    <div class="truncate text-xs text-fg-primary max-w-[180px]" title="${name}">
                        üìÑ ${name}
                    </div>
                    <button onclick="removeDocument('${name}')" class="text-fg-secondary hover:text-danger transition opacity-50 group-hover:opacity-100" title="Remove from RAM">
                        üóëÔ∏è
                    </button>
                `;
                listContainer.appendChild(div);
            });
            
            totalChunksEl.textContent = totalChunks;
        }

        function removeDocument(name) {
            if(confirm(`Remove '${name}' from memory? This action cannot be undone.`)) {
                delete loadedDocuments[name];
                updateDocListUI();
                appendSystemMessage(`Dropped document: ${name}`);
            }
        }

        // --- PDF PROCESSING (LOCAL) ---
        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Fix: Ensure pdfjsLib is available
            if (typeof pdfjsLib === 'undefined') {
                alert("PDF Library failed to load. Please check your internet connection or reload.");
                return;
            }

            if (file.type !== 'application/pdf') {
                alert("Please upload a valid PDF file.");
                return;
            }
            
            if (loadedDocuments[file.name]) {
                alert("Document already loaded in memory.");
                return;
            }

            const statusDoc = document.getElementById('status-doc');
            if (statusDoc) statusDoc.textContent = "Parsing...";
            appendSystemMessage(`Reading <strong>${file.name}</strong> into RAM...`);

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + "\n";
                    if (statusDoc) statusDoc.textContent = `${Math.round((i / pdf.numPages) * 100)}%`;
                }

                if (!fullText.trim()) {
                    throw new Error("PDF appears to be empty or scanned images (OCR not supported locally).");
                }

                // Chunking
                const chunks = chunkText(fullText, 1000, 200);
                
                // Save to State
                loadedDocuments[file.name] = chunks;
                
                updateDocListUI();
                if (statusDoc) statusDoc.textContent = "Ready";
                appendSystemMessage(`Securely loaded: <strong>${file.name}</strong> (${chunks.length} chunks)`);

            } catch (error) {
                console.error(error);
                appendSystemMessage(`Error parsing PDF: ${error.message}`, true);
                if (statusDoc) statusDoc.textContent = "Error";
            }
            input.value = ''; 
        }

        function chunkText(text, chunkSize, overlap) {
            const chunks = [];
            for (let i = 0; i < text.length; i += (chunkSize - overlap)) {
                chunks.push(text.slice(i, i + chunkSize));
            }
            return chunks;
        }

        // --- LOCAL RETRIEVAL ---
        function retrieveRelevantChunks(query, limit = 5) {
            const allChunks = Object.values(loadedDocuments).flat();
            
            if (allChunks.length === 0) return [];
            const queryTerms = query.toLowerCase().split(/\s+/).filter(w => w.length > 3);
            
            const scoredChunks = allChunks.map(chunk => {
                const chunkLower = chunk.toLowerCase();
                let score = 0;
                queryTerms.forEach(term => {
                    score += (chunkLower.match(new RegExp(term, "g")) || []).length;
                });
                return { text: chunk, score: score };
            });

            return scoredChunks.filter(c => c.score > 0).sort((a, b) => b.score - a.score).slice(0, limit).map(c => c.text);
        }

        // --- CHAT LOGIC ---
        async function handleSend() {
            const input = document.getElementById('chat-input');
            const query = input.value.trim();
            if (!query) return;
            
            if (!config.apiKey) {
                alert("Please configure your API Key/Endpoint in Settings.");
                toggleSettings();
                return;
            }

            input.value = '';
            appendUserMessage(query);
            const thinkingId = appendThinking();
            const indicator = document.getElementById('context-indicator');

            try {
                let context = "";
                let systemInstruction = "You are Orochimaru. Answer concisely.";

                if (Object.keys(loadedDocuments).length > 0) {
                    indicator.style.opacity = "1";
                    const relevantChunks = retrieveRelevantChunks(query);
                    if (relevantChunks.length > 0) {
                        context = "CONTEXT FROM LOCAL DOCS:\n" + relevantChunks.join("\n---\n");
                        systemInstruction += " Use the context provided to answer.";
                    }
                }

                const fullPrompt = `${systemInstruction}\n\n${context}\n\nUSER: ${query}`;
                
                // Get Selected Model and Temp
                const selectedModel = document.getElementById('model-select').value;
                const temperature = parseFloat(document.getElementById('temp-slider').value);

                // Track Start Time
                const startTime = performance.now();

                let result = { text: "", usage: null };
                if (config.provider === 'gemini') result = await callGemini(fullPrompt, selectedModel, temperature);
                else if (config.provider === 'groq') result = await callGroq(fullPrompt, selectedModel, temperature);
                else if (config.provider === 'hf') result = await callHF(fullPrompt, selectedModel, temperature);
                else if (config.provider === 'ollama') result = await callOllama(fullPrompt, selectedModel, temperature);

                const endTime = performance.now();
                
                // Calculate Stats
                const durationSec = (endTime - startTime) / 1000;
                // Fallback token estimation if API doesn't provide usage
                const estimatedTokens = result.usage ? (result.usage.total_tokens || 0) : Math.ceil((fullPrompt.length + result.text.length) / 4);
                const speed = estimatedTokens / durationSec;

                updatePerfStats(estimatedTokens, speed);

                document.getElementById(thinkingId).remove();
                appendAIMessage(result.text);
                lastAIResponse = result.text;

            } catch (error) {
                document.getElementById(thinkingId).remove();
                appendSystemMessage(`Error: ${error.message}`, true);
            } finally {
                indicator.style.opacity = "0";
            }
        }

        function toggleReviewMenu() {
            document.getElementById('review-menu').classList.toggle('hidden');
        }

        function runReview(role) {
            if (Object.keys(loadedDocuments).length === 0) return;
            const systemPrompt = REVIEW_PERSONAS[role] || "You are a helpful assistant.";
            
            const relevant = retrieveRelevantChunks("conclusion results methodology abstract", 8); 
            const context = relevant.join("\n\n");
            const prompt = `${systemPrompt}\n\nBased on these excerpts from the document(s):\n${context}\n\nProvide a critical review.`;
            
            callCustomPrompt(prompt, `Requesting ${role} Review...`);
        }

        async function runQuickAction(type) {
            if (Object.keys(loadedDocuments).length === 0 && type !== 'paraphrase') return;
            
            let prompt = "";
            let displayMsg = "";

            if (type === 'summarize') {
                const chunks = retrieveRelevantChunks("abstract summary conclusion introduction", 6);
                prompt = "Summarize the following text:\n" + chunks.join("\n");
                displayMsg = "Generating Summary...";
            } else if (type === 'key_points') {
                const chunks = retrieveRelevantChunks("important key points results", 6);
                prompt = "Extract bullet points from:\n" + chunks.join("\n");
                displayMsg = "Extracting Key Points...";
            } else if (type === 'paraphrase') {
                if(!lastAIResponse) return alert("No response to paraphrase.");
                prompt = "Paraphrase this text in a different style:\n" + lastAIResponse;
                displayMsg = "Paraphrasing...";
            }

            callCustomPrompt(prompt, displayMsg);
        }

        async function callCustomPrompt(fullPrompt, userFacingText) {
            appendUserMessage(userFacingText);
            const thinkingId = appendThinking();
            const selectedModel = document.getElementById('model-select').value;
            const temperature = parseFloat(document.getElementById('temp-slider').value);
            
            const startTime = performance.now();

            try {
                let result = { text: "", usage: null };
                if (config.provider === 'gemini') result = await callGemini(fullPrompt, selectedModel, temperature);
                else if (config.provider === 'groq') result = await callGroq(fullPrompt, selectedModel, temperature);
                else if (config.provider === 'hf') result = await callHF(fullPrompt, selectedModel, temperature);
                else if (config.provider === 'ollama') result = await callOllama(fullPrompt, selectedModel, temperature);

                const endTime = performance.now();
                const durationSec = (endTime - startTime) / 1000;
                const estimatedTokens = result.usage ? (result.usage.total_tokens || 0) : Math.ceil((fullPrompt.length + result.text.length) / 4);
                const speed = estimatedTokens / durationSec;
                updatePerfStats(estimatedTokens, speed);

                document.getElementById(thinkingId).remove();
                appendAIMessage(result.text);
                lastAIResponse = result.text;
            } catch (error) {
                document.getElementById(thinkingId).remove();
                appendSystemMessage(error.message, true);
            }
        }

        // --- TTS (Text-to-Speech) with Stop Logic ---
        function toggleTTS() {
            const btn = document.getElementById('tts-btn');
            
            if (isSpeaking) {
                // STOP action
                window.speechSynthesis.cancel();
                isSpeaking = false;
                resetTTSButton(btn);
            } else {
                // START action
                if (!lastAIResponse) return;
                
                // Cancel any background speech just in case
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(lastAIResponse);
                
                utterance.onstart = () => {
                    isSpeaking = true;
                    btn.innerHTML = "‚èπÔ∏è"; // Stop icon
                    btn.title = "Stop Speaking";
                    btn.classList.add("text-accent", "animate-pulse");
                };

                utterance.onend = () => {
                    isSpeaking = false;
                    resetTTSButton(btn);
                };

                utterance.onerror = () => {
                    isSpeaking = false;
                    resetTTSButton(btn);
                };

                window.speechSynthesis.speak(utterance);
            }
        }

        function resetTTSButton(btn) {
            btn.innerHTML = "üîä";
            btn.title = "Read Aloud";
            btn.classList.remove("text-accent", "animate-pulse");
        }
        
        // Old function alias for backward compatibility if needed, redirected
        function speakLastResponse() {
            toggleTTS();
        }

        // --- UI HELPERS ---
        function appendUserMessage(text) {
            const div = document.createElement('div');
            div.className = "flex items-start space-x-4 justify-end";
            div.innerHTML = `<div class="bg-accent text-accent-fg p-3 rounded-lg max-w-2xl shadow-md"><p class="text-sm">${text}</p></div>`;
            document.getElementById('chat-history').appendChild(div);
            scrollToBottom();
        }

        function appendAIMessage(text) {
            const div = document.createElement('div');
            div.className = "flex items-start space-x-4";
            const cleanHtml = DOMPurify.sanitize(marked.parse(text));
            div.innerHTML = `<div class="flex-shrink-0 w-10 h-10 bg-tertiary rounded-full flex items-center justify-center font-bold text-accent border border-accent">O</div><div class="bg-tertiary p-4 rounded-lg max-w-3xl shadow-md prose prose-invert text-sm text-fg-primary">${cleanHtml}</div>`;
            document.getElementById('chat-history').appendChild(div);
            scrollToBottom();
        }

        function appendSystemMessage(text, isError = false) {
            const div = document.createElement('div');
            div.className = "flex justify-center my-2";
            div.innerHTML = `<span class="text-xs px-3 py-1 rounded-full ${isError ? 'bg-danger/20 text-danger' : 'bg-primary border border-tertiary text-fg-secondary'}">${text}</span>`;
            document.getElementById('chat-history').appendChild(div);
            scrollToBottom();
        }

        function appendThinking() {
            const id = 'thinking-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start space-x-4";
            div.innerHTML = `<div class="flex-shrink-0 w-10 h-10 bg-tertiary rounded-full flex items-center justify-center font-bold text-accent border border-accent animate-pulse">...</div><div class="bg-tertiary p-3 rounded-lg text-fg-secondary italic text-sm">Thinking...</div>`;
            document.getElementById('chat-history').appendChild(div);
            scrollToBottom();
            return id;
        }

        function scrollToBottom() {
            const el = document.getElementById('chat-history');
            el.scrollTop = el.scrollHeight;
        }

        function clearChat() {
            document.getElementById('chat-history').innerHTML = '';
            sessionTotalTokens = 0; // Reset stats on clear
            updatePerfStats(0, 0); // Reset UI
            appendSystemMessage("Chat history cleared from RAM.");
        }

        // --- API CALLS ---
        async function callGemini(prompt, modelId, temp) {
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${config.apiKey}`;
                const resp = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: temp }
                    })
                });
                if (resp.ok) {
                    const data = await resp.json();
                    const usage = data.usageMetadata || null;
                    return { 
                        text: data.candidates[0].content.parts[0].text,
                        usage: usage
                    };
                } else { 
                    const err = await resp.json();
                    throw new Error(err.error?.message || "Gemini Error");
                }
            } catch(e) { throw e; }
        }

        async function callGroq(prompt, modelId, temp) {
            const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${config.apiKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    messages: [{ role: "user", content: prompt }], 
                    model: modelId,
                    temperature: temp
                })
            });
            if (!resp.ok) throw new Error("Groq Error");
            const data = await resp.json();
            return {
                text: data.choices[0].message.content,
                usage: data.usage // Groq returns usage object
            };
        }

        async function callHF(prompt, modelId, temp) {
            const resp = await fetch(`https://api-inference.huggingface.co/models/${modelId}`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${config.apiKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    inputs: prompt, 
                    parameters: { temperature: temp, return_full_text: false, do_sample: true } 
                })
            });
            if (!resp.ok) throw new Error("Hugging Face Error");
            const data = await resp.json();
            const text = Array.isArray(data) ? data[0].generated_text : data.generated_text;
            // HF doesn't return usage, so we return null and let estimate handle it
            return { text: text, usage: null };
        }

        async function callOllama(prompt, modelId, temp) {
            const resp = await fetch(`${config.apiKey}/api/generate`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    model: modelId, 
                    prompt: prompt, 
                    stream: false,
                    options: { temperature: temp }
                })
            });
            if (!resp.ok) throw new Error("Ollama Error. Check CORS.");
            const data = await resp.json();
            // Ollama returns eval_count (output) and prompt_eval_count (input)
            const usage = {
                prompt_tokens: data.prompt_eval_count || 0,
                completion_tokens: data.eval_count || 0,
                total_tokens: (data.prompt_eval_count || 0) + (data.eval_count || 0)
            };
            return { text: data.response, usage: usage };
        }

    </script>
</body>
</html>