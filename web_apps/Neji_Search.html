<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kusanagi Scholar - Minimalist</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Markdown Parser for pretty AI answers -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0F202D; }
        ::-webkit-scrollbar-thumb { background: #3B5368; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #5E7A91; }
        
        .toggle-checkbox:checked { right: 0; border-color: #ffab40; }
        .toggle-checkbox:checked + .toggle-label { background-color: #ffab40; }
        
        .input-focus-ring:focus-within { box-shadow: 0 0 0 2px #ffab40; border-color: #ffab40; }

        .minimal-bg-pattern {
            background-image: radial-gradient(#25435A 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.05;
        }

        /* Markdown Styles */
        .prose p { margin-bottom: 0.8em; }
        .prose strong { color: #ffab40; font-weight: 600; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.8em; }
        .prose code { background: #193549; padding: 2px 4px; rounded: 4px; font-family: monospace; color: #E0F0FF; }
        .prose pre { background: #193549; padding: 1em; rounded: 8px; overflow-x: auto; margin-bottom: 1em; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0F202D', 'secondary': '#193549', 'tertiary': '#25435A',
                        'accent': '#ffab40', 'accent-fg': '#001A30', 'fg-primary': '#E0F0FF',
                        'fg-secondary': '#8DAABF',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full bg-primary text-fg-primary font-sans antialiased overflow-hidden flex flex-col items-center justify-center p-4 relative">

    <!-- Status Bar -->
    <div class="absolute top-4 left-1/2 -translate-x-1/2 flex items-center space-x-4 text-xs text-fg-secondary bg-secondary px-4 py-2 rounded-lg shadow-md z-50">
        <div class="flex items-center space-x-1">
            <span id="api-status-dot" class="w-2 h-2 bg-red-500 rounded-full"></span>
            <span id="api-status-text">No API Key</span>
        </div>
        <span>|</span>
        <button onclick="toggleSettings()" class="hover:text-accent underline decoration-dotted">Settings</button>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden absolute inset-0 bg-black/80 z-[60] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-secondary p-6 rounded-lg shadow-2xl max-w-md w-full border border-tertiary">
            <h2 class="text-xl font-bold text-accent mb-4">Configuration</h2>
            
            <!-- Tabs -->
            <div class="flex space-x-2 mb-4 border-b border-tertiary pb-2">
                <button onclick="switchTab('hf')" id="tab-hf" class="text-sm font-bold text-accent border-b-2 border-accent pb-1">HuggingFace</button>
                <button onclick="switchTab('gemini')" id="tab-gemini" class="text-sm font-medium text-fg-secondary hover:text-fg-primary pb-1">Google Gemini</button>
                <button onclick="switchTab('groq')" id="tab-groq" class="text-sm font-medium text-fg-secondary hover:text-fg-primary pb-1">Groq</button>
            </div>

            <!-- HF Inputs -->
            <div id="panel-hf" class="provider-panel">
                <label class="block text-sm text-fg-secondary mb-2">Hugging Face Token</label>
                <input type="password" id="hf-token-input" class="w-full bg-tertiary text-fg-primary p-3 rounded border border-tertiary focus:border-accent outline-none mb-4" placeholder="hf_...">
                <p class="text-xs text-fg-secondary mb-2">Good for: Mistral, Phi-3. <a href="https://huggingface.co/settings/tokens" target="_blank" class="underline text-accent">Get Token</a></p>
            </div>

            <!-- Gemini Inputs -->
            <div id="panel-gemini" class="provider-panel hidden">
                <label class="block text-sm text-fg-secondary mb-2">Gemini API Key</label>
                <input type="password" id="gemini-key-input" class="w-full bg-tertiary text-fg-primary p-3 rounded border border-tertiary focus:border-accent outline-none mb-4" placeholder="AIza...">
                <p class="text-xs text-fg-secondary mb-2">Good for: 1M Context, RAG, Reliability. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline text-accent">Get Key</a></p>
            </div>

            <!-- Groq Inputs -->
            <div id="panel-groq" class="provider-panel hidden">
                <label class="block text-sm text-fg-secondary mb-2">Groq API Key</label>
                <input type="password" id="groq-key-input" class="w-full bg-tertiary text-fg-primary p-3 rounded border border-tertiary focus:border-accent outline-none mb-4" placeholder="gsk_...">
                <p class="text-xs text-fg-secondary mb-2">Good for: Extreme Speed (Llama 3). <a href="https://console.groq.com/keys" target="_blank" class="underline text-accent">Get Key</a></p>
            </div>
            
            <div class="border-t border-tertiary mt-2 pt-4">
                <label class="block text-sm text-fg-secondary mb-2">Active Provider</label>
                <select id="active-provider-select" class="w-full bg-tertiary text-fg-primary p-2 rounded border border-tertiary focus:border-accent outline-none mb-4">
                    <option value="hf">Hugging Face</option>
                    <option value="gemini">Google Gemini (Best Free Option)</option>
                    <option value="groq">Groq (Fastest)</option>
                </select>

                <div class="flex justify-end gap-2">
                    <button onclick="toggleSettings()" class="px-4 py-2 text-fg-secondary hover:text-fg-primary">Cancel</button>
                    <button onclick="saveSettings()" class="px-4 py-2 bg-accent text-accent-fg rounded font-bold">Save</button>
                </div>
            </div>
        </div>
    </div>

    <main class="flex-1 flex flex-col items-center w-full max-w-3xl z-10 p-6 transition-all duration-500 ease-in-out" id="main-container">
        
        <div class="absolute inset-0 minimal-bg-pattern z-0 pointer-events-none"></div>

        <!-- Header -->
        <div class="text-center mb-8 z-20 transition-all duration-500" id="header-section">
            <h1 class="text-5xl font-extrabold text-fg-primary mb-2 tracking-tight">Kusanagi <span class="text-accent">Scholar</span></h1>
            <p class="text-fg-secondary text-lg">Multi-Model Research Engine</p>
        </div>

        <!-- Search Bar -->
        <div class="w-full bg-secondary rounded-2xl shadow-2xl input-focus-ring transition-all duration-300 border border-tertiary z-20 relative">
            <div class="flex items-center p-2">
                <div class="pl-4 text-fg-secondary">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <input type="text" 
                       id="search-input"
                       placeholder="Ask a research question..." 
                       class="w-full bg-transparent text-lg text-fg-primary p-4 placeholder-fg-secondary focus:outline-none font-medium"
                       autofocus>
                
                <button onclick="handleSearch()" id="search-btn" class="bg-accent hover:bg-yellow-500 text-accent-fg px-6 py-3 rounded-xl font-bold transition duration-200 flex items-center gap-2 flex-shrink-0">
                    <span>Ask AI</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex items-center justify-center w-full mt-6 space-x-4 z-20" id="controls-section">
            <div class="flex items-center space-x-2 bg-secondary px-4 py-2 rounded-lg border border-tertiary">
                <span class="text-xs text-fg-secondary font-bold uppercase">Active Model:</span>
                <!-- This dropdown populates dynamically based on provider -->
                <select id="model-select" class="bg-transparent text-accent font-bold text-sm focus:outline-none cursor-pointer">
                    <!-- Options injected by JS -->
                </select>
            </div>
        </div>

        <!-- RESULTS AREA (Initially Hidden) -->
        <div id="result-area" class="hidden w-full mt-6 bg-secondary border border-tertiary rounded-xl p-6 shadow-2xl z-20 max-h-[60vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b border-tertiary pb-2">
                <h3 class="text-accent font-bold uppercase text-sm tracking-wider">AI Analysis Result</h3>
                <button onclick="clearResult()" class="text-xs text-fg-secondary hover:text-red-400">Clear</button>
            </div>
            <div id="result-content" class="prose prose-invert text-fg-primary text-sm leading-relaxed">
                <!-- Content goes here -->
            </div>
        </div>

        <!-- Quick Suggestions -->
        <div class="mt-8 flex flex-wrap justify-center gap-3 z-10" id="pills-section">
            <button onclick="fillSearch('Compare the efficiency of solar panels vs wind turbines')" class="px-3 py-1.5 rounded-full border border-tertiary text-fg-secondary text-xs hover:border-accent hover:text-accent transition">Renewable Energy</button>
            <button onclick="fillSearch('Explain the mechanism of action of mRNA vaccines')" class="px-3 py-1.5 rounded-full border border-tertiary text-fg-secondary text-xs hover:border-accent hover:text-accent transition">mRNA Vaccines</button>
            <button onclick="fillSearch('Summarize the history of the Roman Senate')" class="px-3 py-1.5 rounded-full border border-tertiary text-fg-secondary text-xs hover:border-accent hover:text-accent transition">Roman History</button>
        </div>

        <div class="mt-auto pt-4 text-center text-xs text-fg-secondary opacity-50 w-full z-10">
            <p>Powered by your own API keys. Data remains local.</p>
        </div>

    </main>

    <script>
        // --- DOM ELEMENTS ---
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const resultArea = document.getElementById('result-area');
        const resultContent = document.getElementById('result-content');
        const modelSelect = document.getElementById('model-select');
        const settingsModal = document.getElementById('settings-modal');
        const activeProviderSelect = document.getElementById('active-provider-select');
        
        // Input fields
        const hfTokenInput = document.getElementById('hf-token-input');
        const geminiKeyInput = document.getElementById('gemini-key-input');
        const groqKeyInput = document.getElementById('groq-key-input');

        const statusDot = document.getElementById('api-status-dot');
        const statusText = document.getElementById('api-status-text');

        // --- STATE MANAGEMENT ---
        let config = {
            provider: localStorage.getItem('provider') || 'hf',
            hfToken: localStorage.getItem('hf_token') || '',
            geminiKey: localStorage.getItem('gemini_key') || '',
            groqKey: localStorage.getItem('groq_key') || ''
        };

        // Model definitions
        const models = {
            hf: [
                { id: "microsoft/Phi-3-mini-4k-instruct", name: "Phi-3 Mini (Free/Fast)" },
                { id: "mistralai/Mistral-7B-Instruct-v0.3", name: "Mistral 7B" }
            ],
            gemini: [
                { id: "gemini-1.5-flash", name: "Gemini 1.5 Flash (Standard)" },
                { id: "gemini-1.5-flash-latest", name: "Gemini 1.5 Flash (Latest)" },
                { id: "gemini-pro", name: "Gemini 1.0 Pro (Legacy/Stable)" },
                { id: "gemini-1.5-pro", name: "Gemini 1.5 Pro (Smartest)" }
            ],
            groq: [
                { id: "llama3-8b-8192", name: "Llama 3 8B (Instant)" },
                { id: "mixtral-8x7b-32768", name: "Mixtral 8x7B" },
                { id: "gemma-7b-it", name: "Gemma 7B" }
            ]
        };

        // --- INITIALIZATION ---
        function init() {
            // Load saved values
            hfTokenInput.value = config.hfToken;
            geminiKeyInput.value = config.geminiKey;
            groqKeyInput.value = config.groqKey;
            activeProviderSelect.value = config.provider;

            updateModelList();
            checkStatus();
        }

        // --- TAB SWITCHING ---
        function switchTab(provider) {
            document.querySelectorAll('.provider-panel').forEach(el => el.classList.add('hidden'));
            document.getElementById(`panel-${provider}`).classList.remove('hidden');
            
            // Reset styles
            ['hf', 'gemini', 'groq'].forEach(p => {
                const btn = document.getElementById(`tab-${p}`);
                if (p === provider) {
                    btn.className = "text-sm font-bold text-accent border-b-2 border-accent pb-1";
                } else {
                    btn.className = "text-sm font-medium text-fg-secondary hover:text-fg-primary pb-1";
                }
            });
        }

        // --- SETTINGS LOGIC ---
        function toggleSettings() {
            settingsModal.classList.toggle('hidden');
            // Default to active provider tab
            if (!settingsModal.classList.contains('hidden')) {
                switchTab(activeProviderSelect.value);
            }
        }

        function saveSettings() {
            config.provider = activeProviderSelect.value;
            config.hfToken = hfTokenInput.value.trim();
            config.geminiKey = geminiKeyInput.value.trim();
            config.groqKey = groqKeyInput.value.trim();
            
            localStorage.setItem('provider', config.provider);
            localStorage.setItem('hf_token', config.hfToken);
            localStorage.setItem('gemini_key', config.geminiKey);
            localStorage.setItem('groq_key', config.groqKey);
            
            updateModelList();
            checkStatus();
            toggleSettings();
        }

        function updateModelList() {
            const provider = activeProviderSelect.value;
            const providerModels = models[provider] || [];
            
            modelSelect.innerHTML = providerModels.map(m => 
                `<option value="${m.id}">${m.name}</option>`
            ).join('');
        }

        function checkStatus() {
            let hasKey = false;
            if (config.provider === 'hf' && config.hfToken) hasKey = true;
            if (config.provider === 'gemini' && config.geminiKey) hasKey = true;
            if (config.provider === 'groq' && config.groqKey) hasKey = true;

            if (hasKey) {
                statusDot.classList.remove('bg-red-500');
                statusDot.classList.add('bg-green-500', 'animate-pulse');
                statusText.textContent = `${config.provider.toUpperCase()} Ready`;
                statusText.classList.add('text-green-400');
            } else {
                statusDot.classList.add('bg-red-500');
                statusDot.classList.remove('bg-green-500', 'animate-pulse');
                statusText.textContent = "Missing Key";
                statusText.classList.remove('text-green-400');
            }
        }

        // --- SEARCH LOGIC ---
        function fillSearch(text) {
            searchInput.value = text;
            searchInput.focus();
        }

        function clearResult() {
            resultArea.classList.add('hidden');
            searchInput.value = '';
            document.getElementById('header-section').classList.remove('scale-75', '-translate-y-4');
            document.getElementById('pills-section').classList.remove('hidden');
        }

        async function handleSearch() {
            const query = searchInput.value.trim();
            if (!query) return;

            // Check key
            let key = "";
            if (config.provider === 'hf') key = config.hfToken;
            if (config.provider === 'gemini') key = config.geminiKey;
            if (config.provider === 'groq') key = config.groqKey;

            if (!key) {
                alert(`Please enter your API Key for ${config.provider.toUpperCase()} in Settings.`);
                toggleSettings();
                return;
            }

            // UI Loading
            searchBtn.disabled = true;
            searchBtn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            
            document.getElementById('header-section').classList.add('scale-75', '-translate-y-4');
            document.getElementById('pills-section').classList.add('hidden');
            resultArea.classList.remove('hidden');
            resultContent.innerHTML = '<span class="animate-pulse">Contacting Neural Matrix...</span>';

            try {
                const modelId = modelSelect.value;
                let markdownText = "";

                if (config.provider === 'hf') {
                    markdownText = await callHuggingFace(query, modelId, key);
                } else if (config.provider === 'gemini') {
                    markdownText = await callGemini(query, modelId, key);
                } else if (config.provider === 'groq') {
                    markdownText = await callGroq(query, modelId, key);
                }

                resultContent.innerHTML = marked.parse(markdownText);

            } catch (error) {
                resultContent.innerHTML = `<span class="text-red-400 font-bold">Error:</span> <span class="text-fg-secondary">${error.message}</span>`;
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = `<span>Ask AI</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>`;
            }
        }

        // --- API IMPLEMENTATIONS ---

        // 1. HUGGING FACE
        async function callHuggingFace(query, model, token) {
            const systemPrompt = "You are a helpful research assistant. Provide concise, accurate answers.";
            let fullPrompt = `<s>[INST] ${systemPrompt} ${query} [/INST]`; // Basic prompt format
            
            const response = await fetch(`https://api-inference.huggingface.co/models/${model}`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    inputs: fullPrompt,
                    parameters: { max_new_tokens: 350, return_full_text: false }
                })
            });
            
            if (!response.ok) throw new Error(`HF Error: ${response.status} ${response.statusText}`);
            const data = await response.json();
            return Array.isArray(data) ? data[0].generated_text : data.generated_text;
        }

        // 2. GOOGLE GEMINI
        async function callGemini(query, model, key) {
            // Clean URL construction to ensure no spaces or bad chars
            const cleanModel = model.trim();
            const cleanKey = key.trim();
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${cleanModel}:generateContent?key=${cleanKey}`;
            
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: query }] }],
                    generationConfig: { maxOutputTokens: 350 }
                })
            });

            if (!response.ok) {
                // If 404, it usually means the model ID is wrong (or legacy alias deprecated)
                if (response.status === 404) {
                     throw new Error(`Gemini Error: 404 (Model '${cleanModel}' not found). Try a different model version in Settings.`);
                }
                throw new Error(`Gemini Error: ${response.status}`);
            }
            
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            // Check if candidates exist (sometimes safety filters block result)
            if (!data.candidates || data.candidates.length === 0) {
                return "No response generated. (It might have been blocked by safety filters).";
            }
            
            return data.candidates[0].content.parts[0].text;
        }

        // 3. GROQ
        async function callGroq(query, model, key) {
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${key}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    messages: [
                        { role: "system", content: "You are a helpful research assistant." },
                        { role: "user", content: query }
                    ],
                    model: model,
                    max_tokens: 350
                })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(`Groq Error: ${err.error?.message || response.status}`);
            }
            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Allow Enter key
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSearch();
        });

        // Init on load
        init();

    </script>
</body>
</html>